<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Provenance Viewer — Readwise→Audio</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; margin: 20px; }
    .container { max-width: 900px; margin: auto; }
    .segment { border: 1px solid #ddd; padding: 8px; margin: 8px 0; border-radius: 6px; }
    .meta { font-size: 0.9em; color: #444; }
    pre { background:#f8f8f8; padding:8px; border-radius:6px; overflow:auto }
  </style>
</head>
<body>
  <div class="container">
    <h1>Provenance Viewer</h1>
    <p>Load an <code>out_audio.metadata.json</code> produced by the prototype to inspect segments & source provenance.</p>
    <input id="fileinput" type="file" accept=".json" />
    <div id="summary"></div>
    <div id="segments"></div>
  </div>

  <script>
    const fileinput = document.getElementById('fileinput');
    const summary = document.getElementById('summary');
    const segments = document.getElementById('segments');

    fileinput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const text = await f.text();
      let data;
      try { data = JSON.parse(text); } catch (err) { summary.innerHTML = '<p style="color:red">Invalid JSON file</p>'; return; }

      summary.innerHTML = `<p>Run: <strong>${data.run_id || 'unknown'}</strong> — Generated at: ${data.generated_at || 'n/a'}</p>`;

      segments.innerHTML = '';
      const prov = data.highlights_provenance || [];
      if (prov.length === 0) {
        segments.innerHTML = '<p>No highlights found in metadata.</p>';
        return;
      }

      prov.forEach((h, idx) => {
        const div = document.createElement('div');
        div.className = 'segment';
        const p = document.createElement('div');
        p.innerHTML = `<strong>#${idx + 1} — ${h.title || 'untitled'}</strong>`;
        const meta = document.createElement('div');
        meta.className = 'meta';
        const pr = h.provenance || {};
        meta.innerHTML = `Author: ${pr.author || 'n/a'} — Exported: ${pr.exported_at || 'n/a'} — checksum: <code>${pr.checksum || 'n/a'}</code>`;
        const excerpt = document.createElement('pre');
        excerpt.textContent = (h.excerpt || pr.excerpt || '') || 'no excerpt available';
        div.appendChild(p);
        div.appendChild(meta);
        div.appendChild(excerpt);
        // link to doc_url if present
        if (pr.doc_url) {
          const a = document.createElement('a');
          a.href = pr.doc_url;
          a.textContent = 'Open source document';
          a.target = '_blank';
          div.appendChild(a);
        }
        segments.appendChild(div);
      });
    });
  </script>
</body>
</html>
